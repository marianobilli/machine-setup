name: CI

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
    types: [opened, synchronize, reopened, ready_for_review]

# Cancel in-progress runs when a new workflow with the same group name is triggered
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write  # For commenting on PRs

jobs:
  shellcheck:
    name: ShellCheck Linting
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Run ShellCheck
        uses: ludeeus/action-shellcheck@master
        with:
          scandir: '.'
          severity: warning
          ignore_paths: '.git'

  test-ubuntu:
    name: Test on Ubuntu
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install zsh
        run: sudo apt-get update && sudo apt-get install -y zsh

      - name: Run dry-run test
        shell: zsh {0}
        run: |
          chmod +x setup.sh
          ./setup.sh --dry-run --profile minimal || true

      - name: Run test suite
        shell: bash
        run: |
          chmod +x tests/test_setup.sh
          ./tests/test_setup.sh

      - name: Verify library files are valid
        shell: bash
        run: |
          bash -n lib/common.sh
          bash -n lib/preflight.sh

      - name: Verify script files are valid
        shell: bash
        run: |
          bash -n scripts/doctor.sh
          bash -n scripts/update.sh
          bash -n scripts/uninstall.sh

  test-macos:
    name: Test on macOS
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Verify zsh is available
        run: which zsh

      - name: Run dry-run test
        shell: zsh {0}
        run: |
          chmod +x setup.sh
          ./setup.sh --dry-run --profile minimal || true

      - name: Run test suite
        shell: bash
        run: |
          chmod +x tests/test_setup.sh
          ./tests/test_setup.sh

      - name: Verify library files are valid
        shell: bash
        run: |
          bash -n lib/common.sh
          bash -n lib/preflight.sh

      - name: Verify script files are valid
        shell: bash
        run: |
          bash -n scripts/doctor.sh
          bash -n scripts/update.sh
          bash -n scripts/uninstall.sh

  validate-configs:
    name: Validate Configuration Files
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Check versions.conf exists
        run: test -f config/versions.conf

      - name: Check profile configs exist
        run: |
          test -f config/profiles/minimal.conf
          test -f config/profiles/full.conf
          test -f config/profiles/k8s-dev.conf

      - name: Validate profile syntax
        run: |
          bash -n config/profiles/minimal.conf || true
          bash -n config/profiles/full.conf || true
          bash -n config/profiles/k8s-dev.conf || true

  documentation:
    name: Documentation Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Check README exists
        run: test -f README.md

      - name: Check CHANGELOG exists
        run: test -f CHANGELOG.md

      - name: Check CLAUDE.md exists
        run: test -f CLAUDE.md

      - name: Verify README has basic sections
        run: |
          grep -q "## Features" README.md
          grep -q "## Quick Start" README.md
          grep -q "## Installed Tools" README.md

  # This job serves as the branch protection rule check
  # It will only pass if all other jobs pass
  all-checks-pass:
    name: All Checks Passed
    runs-on: ubuntu-latest
    needs: [shellcheck, test-ubuntu, test-macos, validate-configs, documentation]
    if: always()

    steps:
      - name: Check all jobs status
        run: |
          if [[ "${{ needs.shellcheck.result }}" != "success" ]] || \
             [[ "${{ needs.test-ubuntu.result }}" != "success" ]] || \
             [[ "${{ needs.test-macos.result }}" != "success" ]] || \
             [[ "${{ needs.validate-configs.result }}" != "success" ]] || \
             [[ "${{ needs.documentation.result }}" != "success" ]]; then
            echo "âŒ One or more required checks failed"
            echo ""
            echo "Check results:"
            echo "  ShellCheck: ${{ needs.shellcheck.result }}"
            echo "  Ubuntu Tests: ${{ needs.test-ubuntu.result }}"
            echo "  macOS Tests: ${{ needs.test-macos.result }}"
            echo "  Config Validation: ${{ needs.validate-configs.result }}"
            echo "  Documentation: ${{ needs.documentation.result }}"
            exit 1
          else
            echo "âœ… All required checks passed!"
            echo ""
            echo "Check results:"
            echo "  ShellCheck: ${{ needs.shellcheck.result }}"
            echo "  Ubuntu Tests: ${{ needs.test-ubuntu.result }}"
            echo "  macOS Tests: ${{ needs.test-macos.result }}"
            echo "  Config Validation: ${{ needs.validate-configs.result }}"
            echo "  Documentation: ${{ needs.documentation.result }}"
          fi

      - name: PR Check Summary
        if: github.event_name == 'pull_request'
        run: |
          echo "### âœ… All CI Checks Passed!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "This PR has passed all required checks:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… ShellCheck Linting" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Ubuntu Tests (51 tests)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… macOS Tests (51 tests)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Configuration Validation" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Documentation Checks" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Ready for review and merge!** ðŸš€" >> $GITHUB_STEP_SUMMARY
